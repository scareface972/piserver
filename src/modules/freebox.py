import modules
import re, urllib
from threading import Thread
from time import sleep

# Tableau des modules (classe) dispo (pour eviter le parsage du document lors du chargement dynamique des modules)
MODULES = ['Freebox']

START_TV_DELAY = 8

class Freebox(modules.Switch):
	"""Class 'Freebox', télécommande de la Freebox"""

	def __init__(self, conf):
		self.muted = False
		key = "((\w+\s)?("+conf['name']
		if 'where' in conf: key += "|"+conf['where']
		if 'alias' in conf: key += "|"+conf['alias']
		key += ")\s?)"
		toggle = conf['name']
        # Initialisation des commandes disponibles
		cmds = {
			'toggle' : toggle,
			#'power': "(allumer?|etein(dre|s))\s("+key+")+",
            'on': "allumer?\s"+key+"+",
            'off': "(etein(dre|s))\s"+key+"+",
			'home': "accueil",
			'ok': "ok|valider" + modules.Module.REPEAT,
			'mute': "silence|mute|coupe le son|remets le son",
			'vol_inc': "(monter?|augmenter?|plus)\s(\w+\s)?(son|volume|fort)" + modules.Module.REPEAT,
			'vol_dec': "(baisser?|diminuer?|redui(s|re)|moins)\s(\w+\s)?(son|volume|fort)" + modules.Module.REPEAT,
			'prgm_inc': "(chaine suivante)" + modules.Module.REPEAT,
			'prgm_dec': "(chaine precedente)" + modules.Module.REPEAT,
			'red': "annuler|retour" + modules.Module.REPEAT,
			'green': "menu\s("+key+")+",
			'yellow': "(info(rmation)?\s("+key+"|programme)+)|page precedente",
			'blue': "page suivante",
			'left': "((vers la\s)?gauche)" + modules.Module.REPEAT,
			'right': "((vers la\s)?droite)" + modules.Module.REPEAT,
			'up': "((vers le\s)?haut|monter)" + modules.Module.REPEAT,
			'down': "((vers le\s)?bas|descendre)" + modules.Module.REPEAT,
			'rec': "enregistrer le programme",
			'rewind': "reculer" + modules.Module.REPEAT,
			'play': "reprendre la lecture",
			'pause': "mettre en pause",
			'forward': "avancer" + modules.Module.REPEAT
		}
		super().__init__(conf, cmds, True)
		self.url = "http://" + conf['box'] + ".freebox.fr/pub/remote_control?code=" + conf['code'];
		# print(self.url)


	def analys(self, qry):
		cmds = super().analys(qry)
		if len(cmds) == 0:
			# Recherche d'une chaine
			rs = re.match("^((chaine|canal) )?(?P<canal>(\d+))", qry)
			if rs: cmds = [self.name + '/' + rs.group('canal')]
			# Ou recherche d'une commande de télécommande
			else:
				for name, canal in CHAINES.items():
					if name == qry:
						cmds = [self.name + '/' + str(canal)]
			#elif qry in CHAINES:
			#	index = CHAINES.index(qry)
			#	if index > -1: cmds = [self.name + '/' + str(index+1)]
		return cmds

	def execute(self, key, longPress=False):
		# Execution de la requete sur l'api télécommande de la box
		result = dict(success=False, name=self.name, state=self.state)
		if key == 'on' and self.state:
			return result
		elif key == 'off' and not self.state:
			return result
		if '/' in key:
			k = key.split('/')
			key = k[0]
			repeat = int(k[1])
		else: repeat = 1
		if (key == 'vol_inc' or key == 'vol_down') and repeat == 1:
			repeat = 10
		longPress = str(1 if longPress else 0)
		if key == 'on' or key == 'off': key = 'power'
		if key == 'power' or key == 'toggle' or self.state:
			if key.isdigit():
				for k in key:
					url = self.url + '&key=' + k + '&long=' + longPress
					print(url)
					req = urllib.request.Request(url)
					try: p = urllib.request.urlopen(req)
					except: pass
			else:
				url = self.url + '&key=' + key + '&long=' + longPress
				print(url)
				for r in range(repeat):
					req = urllib.request.Request(url)
					try: p = urllib.request.urlopen(req)
					except: pass
			result['success'] = True
			if key == 'power' or key == 'toggle':
				self.state = not self.state
				if self.state:
					t = StartTV(self)
					t.start()
			elif key == 'mute':
				self.muted = not self.muted
		return result

class StartTV(Thread):
	def __init__(self, callback):
		Thread.__init__(self)
		self.callback = callback

	def run(self):
		# print("StartTV")
		sleep(START_TV_DELAY)
		self.callback.execute('ok')

CHAINES = {
	"tf 1": 1,
	"france 2": 2,
	"france 3": 3,
	"canal plus": 4,
	"france 5": 5,
	"m6": 6,
	"arte": 7,
	"d8": 8,
	"w9": 9,
	"tmc": 10,
	"nt1": 11,
	"nrj 12": 12,
	"lcp": 13,
	"france 4": 14,
	"bfm tv": 15,
	"i tele": 16,
	"d17": 17,
	"gulli": 18,
	"france o": 19,
	"hd1": 20,
	"equipe 21": 21,
	"6ter": 22,
	"numero23": 23,
	"rmc decouverte": 24,
	"cherie 25": 25,
	"rtl9": 28,
	"vivolta": 38,
	"ab 1": 39,
	"disney channel": 48,
	"paramount channel": 56,
	"national geographic channel": 57,
	"nat geo wild": 58,
	"voyage": 59,
	"nrj hits": 65,
	"game one music hd": 66,
	"clubbing tv": 73,
	"o five": 74,
	"just4talent": 76,
	"virgin radio tv": 77,
	"tv5": 79,
	"bfm business": 80,
	"euronews": 82,
	"bloomberg tv": 83,
	"al jazeera int.": 85,
	"sky news int.": 87,
	"i24 news": 88,
	"cnbc": 89,
	"lcp an 24h": 90,
	"public senat 24h": 91,
	"campagnes tv": 92,
	"africa 24": 93,
	"france 24": 95,
	"france 24 anglais": 96,
	"france 24 arabe": 97,
	"gongbase": 116,
	"game one": 118,
	"game one +1": 119,
	"lucky jack hd": 121,
	"men's up": 122,
	"nolife": 123,
	"enorme tv": 125,
	"nrj paris sat": 128,
	"fashion tv": 131,
	"world fashion": 132,
	"equidia live": 137,
	"equidia life": 138,
	"ab moteurs": 143,
	"ginx": 145,
	"ikono": 150,
	"montagne tv": 156,
	"luxe.tv hd": 157,
	"demain !": 163,
	"kto": 164,
	"3flow 3d": 166,
	"souvenirs from earth": 169,
	"penthouse hd": 176,
	"astro center tv": 195,
	"cash tv": 196,
	"m6 boutique": 197,
	"best of shopping": 198,
	"mce": 199,
	"beblack": 212,
	"grandlille tv": 330,
	"tlt toulouse": 331,
	"tv7 bordeaux": 332,
	"8 mont-blanc": 333,
	"telegrenoble": 334,
	"telif": 335,
	"la locale": 336,
	"normandie tv": 337,
	"telenantes nantes 7": 338,
	"la chaine marseille": 339,
	"clermont premiere": 340,
	"tv tours": 341,
	"nrj paris": 342,
	"bfm business paris": 343,
	"idf1": 344,
	"locales idf": 345,
	"alsace 20": 346,
	"telessonne": 347,
	"tvfil78": 348,
	"weo": 349,
	"tlm": 350,
	"valenciennes tv": 351,
	"canal10 guadeloupe": 352,
	"yvelines premiere": 353,
	"calaisis tv": 354,
	"tv sud camargue-cevennes": 355,
	"mirabelle tv": 356,
	"vosges television": 357,
	"tv sud montpellier": 358,
	"maritima tv": 359,
	"tv vendee": 360,
	"opal tv": 361,
	"canal 32": 362,
	"tna": 363,
	"tvr": 364,
	"tebesud": 365,
	"tebeo": 366,
	"d!ci tv": 367,
	"mfm tv": 368,
	"sud1ere": 470,
	"vox africa panafrique": 475,
	"mboa tv": 478,
	"medi1tv": 480,
	"canal algerie": 481,
	"algerie 3": 482,
	"algerie 5": 483,
	"tamazight tv4": 484,
	"beur tv": 486,
	"cctv documentaire": 499,
	"cctv news": 501,
	"cctv-f": 502,
	"arirang": 516,
	"tv romania": 521,
	"god tv": 529,
	"noursat": 530,
	"telesur": 531,
	"tvci": 540,
	"telenova": 541,
	"rai uno": 543,
	"rai due": 544,
	"rai tre": 545,
	"imed tv": 554,
	"ennahar": 555,
	"skyturk": 556,
	"ulusal kanal": 557,
	"arriyadia": 558,
	"2m maroc": 564,
	"tvm europe": 565,
	"hannibal tv": 566,
	"television tunisienne": 567,
	"al masriya": 568,
	"al jazeera": 569,
	"al jazeera children": 570,
	"powertürk tv": 582,
	"trt1": 583,
	"trt coçuk": 586,
	"kanal 24": 589,
	"trt int": 590,
	"kanal 7 int": 591,
	"samanyolu tv": 592,
	"tvt": 593,
	"hilal tv": 594,
	"tv5 turkey": 595,
	"halk tv": 600,
	"vtv4": 606,
	"arte de": 616,
	"dw-tv": 617,
	"rtpi": 626,
	"kuwait tv1": 640,
	"yemen tv": 643,
	"dubai tv": 644,
	"abou dhabi tv": 645,
	"baraem": 646,
	"jordan satellite channel": 648,
	"armenia 1": 650,
	"armenia tv": 651,
	"vesti": 653,
	"nessma": 657,
	"nhk world sd": 680,
	"ntd television": 684,
	"russia today": 694,
	"russia today esp.": 695,
	"record international": 697,
	"russian al yaum": 698,
	"record news": 699,
	"aktu freebox tv": 999,
	"paris premiere": 26,
	"teva": 27,
	"action": 33,
	"cine polar": 34,
	"cine fx": 35,
	"tcm cinema": 36,
	"e!": 37,
	"frissons extremes": 40,
	"canal plus cinema": 41,
	"canal plus sport": 42,
	"canal plus series": 43,
	"canal plus family": 44,
	"canal plus decale": 45,
	"bein sports 1": 46,
	"bein sports 2": 47,
	"disney channel +1": 49,
	"cine+ famiz": 53,
	"m6 music": 60,
	"m6 music club": 61,
	"m6 music black": 62,
	"trace tropical": 63,
	"trace urban": 64,
	"mezzo": 68,
	"mezzo live hd": 69,
	"mcm": 70,
	"mcm top": 71,
	"mcm pop": 72,
	"fox news": 78,
	"cnn": 84,
	"bbc world news": 86,
	"arret sur images.tv": 94,
	"academy video": 103,
	"vod mania": 105,
	"univers cine": 107,
	"coach club": 108,
	"cinema(s) a la demande": 109,
	"boing": 111,
	"boomerang": 112,
	"baby tv": 113,
	"teletoon": 114,
	"piwi": 115,
	"kztv": 117,
	"gong": 124,
	"mangas": 126,
	"fashion tv hd": 127,
	"stylia": 129,
	"eurochannel": 130,
	"sundance channel hd": 133,
	"trace sport stars": 136,
	"fightbox hd": 139,
	"sport365": 140,
	"pfc": 148,
	"golf channel": 149,
	"travel channel": 151,
	"nature hd": 152,
	"nautical channel": 153,
	"escales": 155,
	"histoire": 158,
	"toute  histoire": 159,
	"animaux": 160,
	"chasse et peche": 161,
	"encyclo": 162,
	"myzen hd": 165,
	"3a telesud": 167,
	"the museum channel": 168,
	"pink gay vod": 173,
	"hot video": 174,
	"penthouse hd1": 177,
	"penthouse hd2": 178,
	"brazzers tv": 179,
	"brazzers tv j-1": 180,
	"brazzers tv j-2": 181,
	"brazzers tv j-3": 182,
	"hustler tv": 183,
	"duosexy": 184,
	"xxl": 185,
	"daring!": 186,
	"dorcel tv": 187,
	"pink tv": 188,
	"man-x": 189,
	"my xxl hd": 190,
	"dorcel xxx": 191,
	"hotvideotv": 192,
	"amatix": 193,
	"iconcerts sd": 200,
	"iconcerts hd": 201,
	"c music": 203,
	"vh1": 204,
	"vh1 classic": 205,
	"brava hd": 206,
	"tele melody": 207,
	"rock tv": 208,
	"relax tv": 209,
	"jukebox": 210,
	"deluxe lounge hd": 211,
	"bein sports max 3": 401,
	"bein sports max 4": 402,
	"bein sports max 5": 403,
	"bein sports max 6": 404,
	"bein sports max 7": 405,
	"bein sports max 8": 406,
	"bein sports max 9": 407,
	"bein sports max 10": 408,
	"rtb burkina faso": 450,
	"ortb (benin)": 451,
	"canal 2 cameroun": 453,
	"crtv cameroun": 454,
	"stv2 cameroun": 455,
	"equinoxe": 456,
	"telecongo congo": 458,
	"rtnc": 459,
	"nollywood": 460,
	"rti 1": 461,
	"gabon television": 462,
	"ortc": 464,
	"ortm mali": 465,
	"2stv senegal": 466,
	"rts senegal": 467,
	"la chaine du futur": 468,
	"africable panafrique": 469,
	"africabox": 476,
	"om5 tv": 477,
	"berbere tv": 487,
	"berbere jeunesse": 488,
	"berbere music": 489,
	"cctv4": 500,
	"cctv divertissement": 503,
	"la chaine du cinema chinois": 504,
	"beijing tv": 505,
	"shangai dragon tv": 506,
	"la chaine de jiangsu": 507,
	"hunan satellite tv": 508,
	"xiamen star tv": 509,
	"zhejiang star tv": 510,
	"tvs2": 511,
	"phoenix infonews": 512,
	"phoenix chinese": 513,
	"zee tv": 514,
	"zee cinema": 515,
	"b4u music (inde)": 518,
	"protv": 522,
	"bbc entertainment": 526,
	"ritmoson latino": 532,
	"de pelicula": 533,
	"tl novelas": 534,
	"canal de las est.": 535,
	"telehit": 536,
	"tve int.": 537,
	"canal 24 horas": 538,
	"antenna 1 (grece)": 542,
	"mediaset italia": 546,
	"rtr planeta": 547,
	"tvn 24": 551,
	"tvp polonia": 560,
	"tvp kultura": 561,
	"tvp info": 562,
	"itvn": 563,
	"art cinema": 572,
	"art movies": 573,
	"al hekayat": 574,
	"iqraa": 575,
	"art aflam 2": 576,
	"cima": 577,
	"mbc": 578,
	"lbc europe": 579,
	"hekayat 2": 580,
	"tv": 581,
	"kanal d": 584,
	"star tv": 585,
	"atv avrupa": 588,
	"tgrt eu": 596,
	"show turk": 599,
	"geo tv": 601,
	"geo news": 602,
	"b4u movies": 603,
	"ctn": 607,
	"tvk": 608,
	"kbs world": 609,
	"613 tv": 613,
	"the israeli network": 614,
	"rtl": 618,
	"rtl2": 619,
	"super rtl": 620,
	"rtl nitro": 621,
	"rtl vox": 622,
	"prosieben": 623,
	"sat1": 624,
	"ntv": 625,
	"sic internacional": 627,
	"deepam tv": 639,
	"shant": 652,
	"murr tv": 654,
	"nbn": 655,
	"future tv": 656,
	"al jadeed": 658,
	"almajd holy quran": 661,
	"almajd al hadeeth": 662,
	"almajd space channel": 663,
	"azhari tv": 665,
	"m hits": 666,
	"m aflam": 667,
	"m drama": 668,
	"moga comedy": 669,
	"mbc masr": 670,
	"mbc 3": 672,
	"rtv pink plus": 673,
	"rtv pink extra": 674,
	"pink film": 675,
	"pink music": 676,
	"jstv1": 681,
	"jstv2": 682,
	"vijay": 685,
	"star life ok": 686,
	"star jalsha": 687,
	"star plus": 688,
	"star gold": 689,
	"channel one russia": 690,
	"dom kino": 691,
	"muzika pervoyo": 692,
	"vremya": 693,
	"tv globo": 696,
	"karusel": 700,
}
